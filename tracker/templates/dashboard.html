{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Welcome & Total Expense Cards -->
    <div class="row g-4">
        <div class="col-md-7">
            <div class="card shadow-sm border-0 p-4 rounded-4">
                <h2 class="fw-bold text-dark"> Welcome  {{ request.user.username }}</h2>
                <p class="text-muted mb-3">Manage your expenses efficiently.<br>View your expenses and summay of total expenses</p>
                <!-- Add Expense Button (Below Welcome Message) -->
               
            </div>
        </div>
        <div class="col-md-5">
            <div class="card shadow-sm border-0 p-4 rounded-4 d-flex flex-row justify-content-between align-items-center">
                
                <!-- Left: Total Expenses -->
                <div class="text-start">
                    <h5 class="text-muted">ðŸ’° Total Expenses</h5>
                    <h3 class="text-dark fw-bold mb-0">â‚¹{{ total_expenses }}</h3>
                </div>
        
                <!-- Right: Add Expense Button -->
                <a href="{% url 'add_expense' %}" class="btn btn-success px-4 py-2 rounded-pill fw-semibold">
                    âž• Add Expense
                </a>
        
            </div>
        </div>       
    </div>

    <div class="mt-4">
        <div class="card shadow-sm border-0 p-3 rounded-4">
            <h5 class="fw-bold text-center">Expense Summary</h5>
            
            <!-- Flexbox for Aligning Charts -->
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <canvas id="pieChart" class="chart-canvas"></canvas>
                <canvas id="barChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>

   <!-- Horizontal Category Filter -->
   <!-- Wrapped in a Card -->
    <div class="mt-4">
        <div class="card shadow-sm border-0 p-3 rounded-4">
            
            <!-- Horizontal Category Filter -->
            <div class="d-flex flex-wrap gap-4 justify-content-start position-relative category-container p-3">
                <a href="#" class="category-link {% if selected_category == 'All' %}active{% endif %}" data-category="All">
                    All Expenses
                </a>
                {% for category in category_summary %}
                    <a href="#" class="category-link {% if selected_category == category.category %}active{% endif %}" 
                    data-category="{{ category.category }}">
                        {{ category.category }} (â‚¹{{ category.total }})
                    </a>
                {% endfor %}
            </div>

            <!-- Expense Table -->
            <div class="table-responsive p-2">
                <table id="expense-table" class="table table-striped">
                    <thead>
                        <tr class="table-dark text-center">
                            <th>Title</th>
                            <th>Amount</th>
                            <th>Category</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                        {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.title }}</td>
                                <td>â‚¹{{ expense.amount }}</td>
                                <td>{{ expense.category }}</td>
                                <td>{{ expense.date }}</td>
                                <td>
                                    <a href="{% url 'edit_expense' expense.id %}" class="btn btn-warning btn-sm">Edit</a>
                                    <a href="{% url 'delete_expense' expense.id %}" 
                                    class="btn btn-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete this expense?');">
                                        Delete
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="5" class="text-center">No expenses found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>


<style>
    /* Category Links */
    .category-container {
        padding-bottom: 10px;
    }

    .category-link {
        text-decoration: none;
        font-size: 15px;
        color: #555;
        font-weight: 500;
        position: relative;
        padding-bottom: 5px;
    }

    .category-link.active {
        color: #007bff;
        font-weight: bold;
    }

    .category-link.active::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: -4px;
        width: 60%;
        height: 2px;
        background-color: #007bff;
        transform: translateX(-50%);
    }

    /* Ensure horizontal scrolling for smaller screens */
    .table-responsive {
        overflow-x: auto;
        white-space: nowrap;
    }

    /* Cards Styling */
    .card {
        border-radius: 12px;
    }
</style>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".category-link").forEach(link => {
            link.addEventListener("click", function (event) {
                event.preventDefault();  // Prevent page reload

                let selectedCategory = this.getAttribute("data-category");

                // Highlight the selected category
                document.querySelectorAll(".category-link").forEach(link => link.classList.remove("active"));
                this.classList.add("active");

                // Fetch filtered expenses via AJAX
                fetch(`/filter_expenses/?category=${selectedCategory}`)
                    .then(response => response.json())
                    .then(data => {
                        let tableBody = document.querySelector("#expense-table tbody");
                        tableBody.innerHTML = "";  // Clear existing rows

                        if (data.expenses.length > 0) {
                            data.expenses.forEach(expense => {
                                let row = `
                                    <tr>
                                        <td>${expense.title}</td>
                                        <td>â‚¹${expense.amount}</td>
                                        <td>${expense.category}</td>
                                        <td>${expense.date}</td>
                                        <td>
                                            <a href="/edit/${expense.id}/" class="btn btn-warning btn-sm">Edit</a>
                                            <a href="/delete/${expense.id}/" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this expense?');">Delete</a>
                                        </td>
                                    </tr>
                                `;
                                tableBody.innerHTML += row;
                            });
                        } else {
                            tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No expenses found.</td></tr>`;
                        }
                    })
                    .catch(error => console.error("Error fetching data:", error));
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>.chart-canvas {
    max-width: 350px;  /* Adjust the width */
    max-height: 350px; /* Adjust the height */
    margin: auto; /* Center align */
    display: block;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    fetch("/filter_expenses/")
        .then(response => response.json())
        .then(data => {
            const categories = data.categories;
            const totals = data.totals;

            console.log("Fetched Categories:", categories);
            console.log("Fetched Totals:", totals);

            // ðŸŽ¯ PIE CHART
            new Chart(document.getElementById("pieChart"), {
                type: "pie",
                data: {
                    labels: categories,
                    datasets: [{
                        data: totals,
                        backgroundColor: ["#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff", "#ff9f40"]
                    }]
                },
                options: { responsive: true }
            });

            // ðŸŽ¯ ANIMATED BAR CHART
            new Chart(document.getElementById("barChart"), {
                type: "bar",
                data: {
                    labels: categories,
                    datasets: [{
                        label: "Total Expense",
                        data: totals,
                        backgroundColor: "#36a2eb",
                        borderColor: "#007bff",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 2000,
                        easing: "easeInOutBounce"
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        })
        .catch(error => console.error("Error fetching data:", error));
});
</script>


{% endblock %}